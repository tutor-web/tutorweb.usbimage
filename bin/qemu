#!/bin/sh -eu
EXTRA_OPTS=""

[ "$1" = "--nogrub" ] && {
    EXTRA_OPTS="${EXTRA_OPTS} -kernel output/rootfs/boot/vmlinuz-*"
    EXTRA_OPTS="${EXTRA_OPTS} -initrd output/rootfs/boot/initrd.img-*"
    EXTRA_OPTS="${EXTRA_OPTS} "'-append root="LABEL=twbox"'
    shift
}
IMAGE="${1-output/images/output-*-default.img}"

#sudo tunctl -u $USER -t tap0
# -snapshot -no-shutdown \
#    -usbdevice disk:format=raw:"$IMAGE" \
#    -net tap,ifname=tap0 \
qemu-system-x86_64 -m 1024M \
    -machine accel=kvm \
    -usb -device usb-ehci,id=ehci \
    -drive format=raw,file="$IMAGE" \
    -vga std \
    -monitor stdio \
    \
    -net nic,model=virtio,macaddr=52:54:00:12:34:00 \
    -net nic,model=e1000,macaddr=52:54:00:12:34:01,vlan=1,model=e1000 \
    -net user \
    ${EXTRA_OPTS}
