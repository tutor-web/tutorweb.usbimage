#!/bin/sh -eu
CMD_LINE="qemu-system-x86_64 -m 2G -machine accel=kvm -usb -device usb-ehci,id=ehci"
CMD_LINE="${CMD_LINE} -vga std -monitor stdio"

CMD_LINE="${CMD_LINE} -net nic,model=virtio,macaddr=52:54:00:12:34:00"
CMD_LINE="${CMD_LINE} -net user"
CMD_LINE="${CMD_LINE} -net nic,model=e1000,macaddr=52:54:00:12:34:01,vlan=1,model=e1000"
CMD_LINE="${CMD_LINE} -net tap,ifname=tap1,vlan=1"

[ "$1" = "--nogrub" ] && {
    CMD_LINE="${CMD_LINE} -kernel output/rootfs/boot/vmlinuz-*"
    CMD_LINE="${CMD_LINE} -initrd output/rootfs/boot/initrd.img-*"
    CMD_LINE="${CMD_LINE} "'-append root="LABEL=twbox"'
    shift
}

IMAGE="${1-output/images/output-*-default.img}"
TWDATA_IMAGE="${2-/non/existant}"
[ -e ${IMAGE} ] && CMD_LINE="${CMD_LINE} -drive format=raw,file=$IMAGE"
[ -e ${TWDATA_IMAGE} ] && CMD_LINE="${CMD_LINE} -drive format=raw,if=virtio,file=${TWDATA_IMAGE}"

eval ${CMD_LINE}
