#!/bin/sh
MOUNTPOINT=./tmpmnt
USBDEV="$1" ; shift
CMD="$1" ; shift

mount_part() {
    [ -b "${USBPART}" ] || { echo "${USBPART} does not exist"; exit 1; }
    echo Mounting ${USBPART} at $MOUNTPOINT ...
    mountpoint -q "$MOUNTPOINT" || mount "${USBPART}" "$MOUNTPOINT" || exit 1
}

do_rootfs() {
    # TODO: (echo o; echo n; echo p; echo 1; echo ; echo; echo w) | sudo fdisk ${USBDEV}
    mkfs.ext4 "${USBPART}"

    mount_part
    tar -C "$MOUNTPOINT" -xvf output/rootfs.tar
}

do_chroot() {
    mount_part
    mount --bind /dev "$MOUNTPOINT/dev" || exit 1
    mount --bind /dev/pts "$MOUNTPOINT/dev/pts" || exit 1
    mount --bind /sys "$MOUNTPOINT/sys" || exit 1
    mount --bind /proc "$MOUNTPOINT/proc" || exit 1
    chroot "$MOUNTPOINT" $* || true
    sleep 1
    umount "$MOUNTPOINT/proc"
    umount "$MOUNTPOINT/sys"
    umount "$MOUNTPOINT/dev/pts"
    umount "$MOUNTPOINT/dev"
}

do_extra_install() {
    do_chroot /usr/bin/apt-get update
    do_chroot /usr/bin/apt-get install nginx mysql-server
}

do_grub_install() {
    do_chroot /usr/sbin/update-grub
    do_chroot /usr/sbin/grub-install "${USBDEV}"
}

[ -b "${USBDEV}" ] || { echo "Block device ${USBDEV} does not exist"; exit 1; }
[ -d "$MOUNTPOINT" ] || mkdir -- "$MOUNTPOINT"
USBPART="${USBDEV}-part1"

do_$CMD "$@"

echo "Unmounting $MOUNTPOINT"
mountpoint -q "$MOUNTPOINT" && umount "$MOUNTPOINT"
rmdir -- "$MOUNTPOINT"
sync
