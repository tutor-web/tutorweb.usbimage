#!/bin/sh -eu

# Generate phonehome key
mkdir -p twpreload/phonehome
[ -f twpreload/phonehome/id_rsa ] || ssh-keygen -f twpreload/phonehome/id_rsa -N ""
[ -f twpreload/phonehome/config ] || cat <<'EOF' > twpreload/phonehome/config
# Example phonehome config, replace with sensible values
Host phonehome
    User phonehome
    HostName phonehome.net
EOF

# NB: preboot-base.sh hard-codes debian backport version
virt-builder debian-10 \
    --output eias.img --format raw \
    --hostname tutorweb-box \
    --arch amd64 \
    --timezone UTC \
    --copy-in 'conf/overlay-webserver/srv:/' \
    --copy-in 'twpreload:/' \
    --run conf/preboot-base.sh \
    --run conf/preboot-network.sh \
    --run conf/preboot-network-wifiap.sh \
    --run conf/preboot-network-usbmodem.sh \
    --run conf/preboot-network-phonehome.sh \
    --run conf/preboot-webserver.sh \
    --run conf/preboot-webserver-fakeinternet.sh \
    --run conf/preboot-webserver-shellinabox.sh \
    --run conf/preboot-kiwix.sh \
    --no-logfile
#    --run conf/preboot-kalite.sh \
#    --run conf/preboot-tutorweb.sh \
#    --run conf/preboot-smileycoin.sh \
